---
import '~/styles/global.css';

import { I18N, METADATA } from 'site-config';

import CommonMeta from '~/components/meta/CommonMeta.astro';
import Favicons from '~/components/meta/Favicons.astro';
import Analytics from '~/components/meta/Analytics.astro';
import Metadata from '~/components/meta/Metadata.astro';
import SiteVerification from '~/components/meta/SiteVerification.astro';
import Container from '~/components/blocks/layout/Container.astro';
import type { MetaData } from '~/types/metadata.types';
import type { ContainerProps } from '~/types/container.types';
import { mergeConfigs } from '~/utils/mergeConfigs';
import Header from '~/components/blocks/composite/Header.astro';

import type { ButtonProps } from '~/types/button.types';
import Modal from '~/components/blocks/layout/Modal.astro';
import NavigationTree from '~/components/blocks/composite/NavigationTree.astro';

export type Props = {
  langCode?: string;
  metadata?: Partial<MetaData>;
  topmostContainer?: Partial<ContainerProps>;
};

const { langCode, metadata, topmostContainer } = Astro.props;

// Find the language configuration
const currentLang =
  I18N.languages.find((lang: (typeof I18N.languages)[number]) => lang.code === langCode) ||
  I18N.languages.find((lang: (typeof I18N.languages)[number]) => lang.code === I18N.default) ||
  I18N.languages[0];

const htmlLang = currentLang.code;
const htmlDir = currentLang.direction;

// Get color scheme from config
const colorScheme = METADATA.theme?.colorScheme || 'light dark';

const defaultTopmostContainer = {
  htmlTag: 'div',
  content: { air: 'none', widthType: 'full' },
} as ContainerProps;

const mergedTopmostContainer = mergeConfigs({}, defaultTopmostContainer, topmostContainer);

const navigationItems: ButtonProps[] = [
  { label: 'Caractéristiques', href: '#caracteristiques' },
  { label: 'Détail du prix', href: '#prix' },
  { label: 'Photos', href: '#photos' },
  { label: 'Plan & Surface', href: '#plan' },
  { label: 'Carte', href: '#carte' },
  { label: 'Visite & Candidature', href: '#candidature' },
  { label: 'FAQ', href: '#faq' },
  { label: 'Contact', href: '#contact' },
];
---

<!doctype html>
<html lang={htmlLang} dir={htmlDir} style="--scroll-padding-top: 6rem;">
  <head>
    <CommonMeta />
    <Favicons />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Initialize theme before page renders to prevent FOUC -->
    <script is:inline define:vars={{ colorScheme }}>
      (function () {
        // Parse color scheme config to determine behavior
        // Values: "normal", "light", "dark", "light dark", "dark light", "only light", "only dark"
        const scheme = colorScheme;

        if (scheme === 'only light') {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
          return;
        }
        if (scheme === 'only dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          return;
        }

        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'light' || storedTheme === 'dark') {
          document.documentElement.setAttribute('data-theme', storedTheme);
          return;
        }

        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let theme;

        if (scheme === 'dark light') {
          theme = prefersDark ? 'dark' : 'light';
        } else {
          theme = prefersDark ? 'dark' : 'light';
        }

        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      })();
    </script>
  </head>
  <body>
    <Container {...mergedTopmostContainer}>
      <Header
        isFloating
        container={{
          content: { boxWidth: 'full' },
          background: {
            class: 'bg-background/70 backdrop-blur-sm',
          },
        }}
        defaultActionsConfig={{
          variant: 'link',
          class: 'text-normal hover:text-normal',
        }}
        logo={{ label: '' }}
        navigationRight={{
          class: 'hidden lg:flex',
          defaultItemConfig: {
            variant: 'link',
            class: 'text-center text-normal font-bold hover:text-normal',
          },
          items: navigationItems,
        }}
        actionsRight={[
          {
            'data-modal-trigger': 'mobile-menu',
            class: 'lg:hidden text-normal hover:text-normal',
            icon: { name: 'heroicons:bars-3' },
          },
        ]}
      />

      <slot />

      <Modal
        id="mobile-menu"
        size="full"
        class="bg-transparent rounded-none shadow-none flex items-center align-middle"
      >
        <NavigationTree
          items={navigationItems}
          defaultItemConfig={{ variant: 'link', size: 'xl', 'data-modal-close': '' }}
        />
      </Modal>
    </Container>

    <!-- modal portal root: server-rendered root for portals (falls back to body append) -->
    <div id="modal-portal-root" class="z-9999"></div>
  </body>
</html>
